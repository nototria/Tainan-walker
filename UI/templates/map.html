<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where Can I Walk?</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 350px;
            background-color: white;
            border: 2px solid grey;
            z-index: 9999;
            font-size: 14px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #controls h4 {
            margin-top: 0;
            color: #333;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            margin-top: 5px;
        }
        .btn-primary { background-color: #2196F3; color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-success { background-color: #4CAF50; color: white; }
        #modeStatus {
            margin-top: 8px;
            font-style: italic;
            padding: 5px;
            border-radius: 3px;
        }
        .status-disabled { background-color: #f0f0f0; color: #666; }
        .status-enabled { background-color: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div id="controls">
        <h4>Point Selection Tool</h4>
        <button id="toggleMode" class="btn btn-primary" onclick="toggleSelectionMode()">
            Enable Selection Mode
        </button>
        <div id="modeStatus" class="status-disabled">
            Selection mode disabled
        </div>
        <div id="info" style="margin-top: 10px;"></div>
        <div style="margin-top: 10px;">
            <button class="btn btn-success" onclick="sendPointsToServer()">
                Confirm Selection
            </button>
            <button class="btn btn-danger" onclick="resetEverything()">
                Reset Everything
            </button>
        </div>
    </div>
    <div id="loading" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-overlay"></div>
    </div>
    <style>
        .spinner {
            margin: 20px auto;
            width: 40px;
            height: 40px;
            border: 5px solid #ccc;
            border-top-color: #2196F3;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99999;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            width: 100%;
            height: 100%;
        }
        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            margin: -30px 0 0 -30px;
            z-index:100000;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([23.147305, 120.305786], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let points = [];
        let markers = [];
        let selectionMode = false;
        let pathLayer = null;

        function updateInfo() {
            const info = document.getElementById('info');
            if (points.length === 1) {
                info.innerHTML = `<div style="padding: 8px; background-color: #e3f2fd; border-radius: 4px;">
                    <b>Point A selected:</b><br>
                    ${points[0].lat.toFixed(6)}, ${points[0].lng.toFixed(6)}<br>
                    <i>Click to select Point B</i></div>`;
            } else if (points.length === 2) {
                info.innerHTML = `<div style="padding: 8px; background-color: #e8f5e8; border-radius: 4px;">
                    <b>Both Points Selected:</b><br>
                    Point A: ${points[0].lat.toFixed(6)}, ${points[0].lng.toFixed(6)}<br>
                    Point B: ${points[1].lat.toFixed(6)}, ${points[1].lng.toFixed(6)}<br>
                    </div>`;
                if (selectionMode) {
                    toggleSelectionMode();
                }
            }
        }

        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            const button = document.getElementById('toggleMode');
            const status = document.getElementById('modeStatus');
            
            if (selectionMode) {
                button.innerHTML = 'Disable Selection Mode';
                button.className = 'btn btn-danger';
                status.innerHTML = 'Selection mode enabled';
                status.className = 'status-enabled';
                document.getElementById('map').style.cursor = 'crosshair';
            } else {
                button.innerHTML = 'Enable Selection Mode';
                button.className = 'btn btn-primary';
                status.innerHTML = 'Selection mode disabled';
                status.className = 'status-disabled';
                document.getElementById('map').style.cursor = '';
            }
        }

        function onMapClick(e) {
            if (!selectionMode || points.length >= 2) {
                return;
            }

            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: #ff4444; 
                    width: 16px; 
                    height: 16px; 
                    border-radius: 50%; 
                    border: 3px solid white; 
                    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                    position: relative;
                "></div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });

            const marker = L.marker(e.latlng, { icon: markerIcon }).addTo(map);
            markers.push(marker);
            points.push(e.latlng);
            updateInfo();
        }

        map.on('click', onMapClick);

        function sendPointsToServer() {
            if (points.length < 2) {
                alert("Select 2 points first.");
                return;
            }

            const data = {
                start: {
                    lat: points[0].lat,
                    lng: points[0].lng
                },
                end: {
                    lat: points[1].lat,
                    lng: points[1].lng
                }
            };

            document.getElementById("loading").style.display = "block";

            fetch('/process_points', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(response => response.json())
            .then(result => {
                document.getElementById("loading").style.display = "none";
                if (result.status === 'success') {
                    console.log("Received path:", result.path);
                    drawPath(result.path);
                    alert("Successfully get recommendation route!");
                } else {
                    alert("Error:" + result.message);
                }
            }).catch(error => {
                document.getElementById("loading").style.display = "none";
                console.error("Failed to fetch path:", err);
                alert("Error:" + error);
            });
        }


        function drawPath(pathCoords) {
            if (!pathCoords || pathCoords.length < 2) return;

            // Define source and target projections
            const projSrc = 'EPSG:32651'; // projected coordinates (your input)
            const projDst = 'EPSG:4326';  // WGS84 lat/lng

            // If proj4 defs not registered, define EPSG:32651 (UTM zone 51N)
            if (!proj4.defs[projSrc]) {
                proj4.defs(projSrc, "+proj=utm +zone=51 +datum=WGS84 +units=m +no_defs");
            }

            // Convert projected coords to lat/lng
            const latlngs = pathCoords.map(p => {
                const [lng, lat] = proj4(projSrc, projDst, [p.lng, p.lat]); // input order: [x, y] = [lng, lat] in meters
                return [lat, lng]; // Leaflet expects [lat, lng]
            });

            // Remove old path layer
            if (pathLayer) {
                map.removeLayer(pathLayer);
            }

            pathLayer = L.polyline(latlngs, {
                color: 'blue',
                weight: 4,
                opacity: 0.8
            }).addTo(map);

            map.fitBounds(pathLayer.getBounds());
        }

        // function drawPath(scoredEdges) {
        //     if (!scoredEdges || scoredEdges.length === 0) return;

        //     // 找出最小與最大分數，為 colormap 正規化用
        //     const scores = scoredEdges.map(e => e.score);
        //     const minScore = Math.min(...scores);
        //     const maxScore = Math.max(...scores);

        //     // 清除舊有路徑
        //     if (pathLayer) {
        //         map.removeLayer(pathLayer);
        //     }
        //     pathLayer = L.layerGroup().addTo(map);

        //     // 使用 d3 插件的 Viridis colormap（或自己定義顏色階）
        //     const colorScale = chroma.scale('viridis').domain([minScore, maxScore]);

        //     // 每條 edge 是一段 LineString
        //     scoredEdges.forEach(edge => {
        //         const latlngs = [
        //             [edge.start_y, edge.start_x],
        //             [edge.end_y,   edge.end_x]
        //         ];

        //         const popup = `
        //             <b>Green ratio</b>: ${edge.green_ratio.toFixed(2)}<br>
        //             <b>Shade</b>: ${edge.shade.toFixed(2)}<br>
        //             <b>Pavement</b>: ${edge.pavement_ratio.toFixed(2)}<br>
        //             <b>Length</b>: ${edge.distance.toFixed(1)} m<br>
        //             <b>Score</b>: ${edge.score.toFixed(2)}
        //         `;

        //         const color = colorScale(edge.score).hex();

        //         const polyline = L.polyline(latlngs, {
        //             color: color,
        //             weight: 4,
        //             opacity: 0.85
        //         }).bindPopup(popup);

        //         polyline.addTo(pathLayer);
        //     });

        //     // Zoom to bounds
        //     const allLatLngs = scoredEdges.flatMap(e => [
        //         [e.start_y, e.start_x],
        //         [e.end_y,   e.end_x]
        //     ]);
        //     map.fitBounds(allLatLngs);
        // }

        function resetEverything() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
            points = [];

            if (pathLayer) {
                map.removeLayer(pathLayer);
                pathLayer = null;
            }

            document.getElementById("info").innerHTML = "";
            if (selectionMode) toggleSelectionMode();
        }
    </script>
</body>
</html>
